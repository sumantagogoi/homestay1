{% extends "base-homestay.html" %}

{% block title %}House Rules Management - Homestay{% endblock %}
{% block page_title %}House Rules{% endblock %}

{% block extra_css %}
<style>
  .house-rules-container {
    background: white;
    border-radius: 8px;
    padding: 25px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .rules-header {
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #667eea;
  }
  .rules-info {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
  }
  .rules-preview {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
  }
  .version-badge {
    font-size: 0.85rem;
    padding: 5px 10px;
    border-radius: 20px;
  }
</style>
{% endblock %}

{% block content %}
<div class="house-rules-container">
  <div class="rules-header">
    <h3><i class="fas fa-file-contract"></i> House Rules Management</h3>
    <p class="text-muted">Edit the house rules that will be displayed to guests during booking</p>
  </div>

  {% if error %}
  <div class="alert alert-danger">
    <i class="fas fa-exclamation-triangle"></i> {{ error }}
  </div>
  {% endif %}

  {% if house_rules %}
  <div class="rules-info">
    <div class="row">
      <div class="col-md-6">
        <strong>Property:</strong> {{ property.name }}<br>
        <strong>Last Updated:</strong> {{ house_rules.updated_at|date:"F d, Y H:i" }}<br>
        {% if house_rules.updated_by %}
        <strong>Updated By:</strong> {{ house_rules.updated_by.username|title }}
        {% endif %}
      </div>
      <div class="col-md-6 text-right">
        <span class="badge badge-primary version-badge">
          Version {{ house_rules.version }}
        </span>
      </div>
    </div>
  </div>

  <form id="houseRulesForm">
    {% csrf_token %}

    <div class="form-group">
      <label for="title">Title Displayed to Guests</label>
      <input type="text" class="form-control" id="title" name="title"
             value="{{ house_rules.title }}" placeholder="e.g., Terms and Conditions">
    </div>

    <div class="form-group">
      <label for="content">
        House Rules Content
        <small class="text-muted">
          Use the editor to format your rules. You can add headings, lists, bold text, links, and more.
        </small>
      </label>
      <textarea id="content" name="content">{{ house_rules.content }}</textarea>
    </div>

    <div class="form-group">
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-save"></i> Save House Rules
      </button>
      <button type="button" class="btn btn-secondary ml-2" onclick="location.reload()">
        <i class="fas fa-undo"></i> Reset
      </button>
    </div>

  </form>

  <div class="rules-preview">
    <h5><i class="fas fa-eye"></i> Preview (How guests will see it)</h5>
    <hr>
    <h6>{{ house_rules.title }}</h6>
    <div id="previewContent">
      {{ house_rules.content|safe }}
    </div>
  </div>

  {% else %}
  <div class="alert alert-warning">
    <i class="fas fa-info-circle"></i> No house rules found. Default rules will be created automatically.
  </div>
  {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<!-- Include Summernote CSS/JS if not already loaded -->
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-bs4.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-bs4.min.js"></script>

<script>
  $(document).ready(function() {
    // Initialize Summernote
    $('#content').summernote({
      placeholder: 'Enter your house rules here...',
      height: 300,
      toolbar: [
        ['style', ['bold', 'italic', 'underline', 'clear']],
        ['font', ['strikethrough', 'superscript', 'subscript']],
        ['fontsize', ['fontsize']],
        ['color', ['color']],
        ['para', ['ul', 'ol', 'paragraph']],
        ['insert', ['link']],
        ['view', ['fullscreen', 'codeview']],
        ['help', ['help']]
      ],
      callbacks: {
        onChange: function(contents, $editable) {
          // Update preview in real-time
          $('#previewContent').html(contents);
        }
      }
    });

    // Handle form submission
    $('#houseRulesForm').on('submit', function(e) {
      e.preventDefault();

      // Get content from Summernote
      var content = $('#content').summernote('code');
      var title = $('#title').val();

      if (!title.trim()) {
        alert('Please enter a title');
        return false;
      }

      if (!content.trim()) {
        alert('Please enter house rules content');
        return false;
      }

      // Submit via AJAX
      $.ajax({
        url: window.location.href,
        method: 'POST',
        data: {
          'title': title,
          'content': content,
          'csrfmiddlewaretoken': getCookie('csrftoken')
        },
        success: function(response) {
          if (response.success) {
            alert(response.message);
            // Optionally reload page to show new version
            location.reload();
          } else {
            alert('Error: ' + response.message);
          }
        },
        error: function() {
          alert('An error occurred while saving house rules.');
        }
      });
    });

    // Function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + '=') {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  });
</script>
{% endblock %}
