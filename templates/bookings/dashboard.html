{% extends "base-homestay.html" %}

{% block title %}Bookings - Homestay Management{% endblock %}
{% block page_title %}Bookings{% endblock %}

{% block extra_css %}
<style>
  .guest-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }
  .guest-badge {
    font-size: 0.85rem;
  }
  .status-active {
    color: #28a745;
  }
  .status-checked-out {
    color: #6c757d;
  }
</style>
{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <h3 class="card-title">All Bookings</h3>
    <div class="card-tools">
      <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#addBookingModal">
        <i class="fas fa-plus"></i> Add Booking
      </button>
    </div>
  </div>

  <div class="card-body">
    <table id="bookingsTable" class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>ID</th>
          <th>Guests</th>
          <th>Check-in</th>
          <th>Check-out</th>
          <th>Phone</th>
          <th>From</th>
          <th>Terms</th>
          <th>Form</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for stay in stays %}
        <tr data-id="{{ stay.id }}">
          <td>{{ stay.id }}</td>
          <td>
            <div class="guest-badges">
              {% for guest in stay.guests.all %}
              <span class="badge badge-primary guest-badge">{{ guest.name }}</span>
              {% endfor %}
            </div>
          </td>
          <td>{{ stay.check_in_date|date:"Y-m-d" }}</td>
          <td>
            {% if stay.check_out_date %}
              {{ stay.check_out_date|date:"Y-m-d" }}
            {% else %}
              <span class="status-active">Active</span>
            {% endif %}
          </td>
          <td>{{ stay.phone_number|default:"-" }}</td>
          <td>{{ stay.coming_from|default:"-" }}</td>
          <td>
            {% if stay.terms_agreed %}
              <i class="fas fa-check-circle text-success"></i>
            {% else %}
              <i class="fas fa-times-circle text-danger"></i>
            {% endif %}
          </td>
          <td>
            {% if stay.form_filled %}
              <i class="fas fa-check-circle text-success"></i>
            {% else %}
              <i class="fas fa-times-circle text-danger"></i>
            {% endif %}
          </td>
          <td>
            <button class="btn btn-sm btn-info" onclick="viewBooking({{ stay.id }})">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-warning" onclick="editBooking({{ stay.id }})">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteBooking({{ stay.id }})">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Add/Edit Booking Modal -->
<div class="modal fade" id="addBookingModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Booking</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="bookingForm">
          {% csrf_token %}

          <div class="form-group">
            <label>Guests</label>
            <div class="input-group">
              <select id="guestSelect" class="form-control" multiple>
                {% for guest in guests %}
                <option value="{{ guest.id }}">{{ guest.name }}</option>
                {% endfor %}
              </select>
              <div class="input-group-append">
                <button type="button" class="btn btn-success" onclick="addNewGuest()">
                  <i class="fas fa-plus"></i> New
                </button>
              </div>
            </div>
            <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple guests</small>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="checkin_date">Check-in Date *</label>
                <input type="date" class="form-control" id="checkin_date" name="checkin_date" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="checkout_date">Check-out Date</label>
                <input type="date" class="form-control" id="checkout_date" name="checkout_date">
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="phone_number">Phone Number</label>
                <input type="text" class="form-control" id="phone_number" name="phone_number" placeholder="Enter phone number">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="email">Email</label>
                <input type="email" class="form-control" id="email" name="email" placeholder="Enter email">
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="coming_from">Coming From</label>
            <input type="text" class="form-control" id="coming_from" name="coming_from" placeholder="City, State, Country">
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <div class="custom-control custom-checkbox">
                  <input class="custom-control-input" type="checkbox" id="terms_agreed" name="terms_agreed">
                  <label class="custom-control-label" for="terms_agreed">Terms Agreed</label>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <div class="custom-control custom-checkbox">
                  <input class="custom-control-input" type="checkbox" id="form_filled" name="form_filled">
                  <label class="custom-control-label" for="form_filled">Form Filled</label>
                </div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="notes">Notes</label>
            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
          </div>

        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="saveBooking()">Save Booking</button>
      </div>
    </div>
  </div>
</div>

<!-- Add New Guest Modal -->
<div class="modal fade" id="addGuestModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Guest</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="guestForm">
          {% csrf_token %}
          <div class="form-group">
            <label for="guest_name">Guest Name *</label>
            <input type="text" class="form-control" id="guest_name" name="guest_name" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveGuest()">Save Guest</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  $(document).ready(function() {
    // Initialize DataTable
    $('#bookingsTable').DataTable({
      'order': [[2, 'desc']], // Sort by check-in date descending (newest first)
      'columnDefs': [
        { 'orderable': false, 'targets': 8 } // Disable sorting on Actions column
      ],
      'pageLength': 25,
      'language': {
        'search': 'Search bookings:',
        'lengthMenu': 'Show _MENU_ bookings per page',
        'info': 'Showing _START_ to _END_ of _TOTAL_ bookings',
        'paginate': {
          'first': 'First',
          'last': 'Last',
          'next': 'Next',
          'previous': 'Previous'
        }
      }
    });

    // Set default check-in date to today
    const today = new Date().toISOString().split('T')[0];
    $('#checkin_date').val(today);
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + '=') {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function addNewGuest() {
    $('#addGuestModal').modal('show');
  }

  function saveGuest() {
    const name = $('#guest_name').val();
    if (!name) {
      alert('Please enter guest name');
      return;
    }

    fetch('/bookings/guests/new/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `name=${encodeURIComponent(name)}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Add new guest to select
        $('#guestSelect').append(new Option(data.guest_name, data.guest_id, true, true));
        $('#addGuestModal').modal('hide');
        $('#guest_name').val('');
      } else {
        alert('Error: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred');
    });
  }

  function saveBooking() {
    const formData = new FormData();
    const guests = $('#guestSelect').val() || [];

    if (guests.length === 0) {
      alert('Please select at least one guest');
      return;
    }

    guests.forEach(guestId => {
      formData.append('guests[]', guestId);
    });

    formData.append('check_in_date', $('#checkin_date').val());
    formData.append('check_out_date', $('#checkout_date').val());
    formData.append('phone_number', $('#phone_number').val());
    formData.append('email', $('#email').val());
    formData.append('coming_from', $('#coming_from').val());
    formData.append('terms_agreed', $('#terms_agreed').is(':checked'));
    formData.append('form_filled', $('#form_filled').is(':checked'));
    formData.append('notes', $('#notes').val());

    fetch('/bookings/stays/new/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Booking saved successfully!');
        location.reload();
      } else {
        alert('Error: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred');
    });
  }

  function viewBooking(id) {
    alert('View booking ' + id + ' - Detail view to be implemented');
  }

  function editBooking(id) {
    // Load booking data into modal
    fetch(`/get-customer-data/${id}/`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const stay = data.data;

          // Set form values
          $('#guestSelect').val(stay.guests.map(g => g.id));
          $('#checkin_date').val(stay.check_in_date);
          $('#checkout_date').val(stay.check_out_date || '');
          $('#phone_number').val(stay.phone_number);
          $('#email').val(stay.email);
          $('#coming_from').val(stay.coming_from);
          $('#terms_agreed').prop('checked', stay.terms_agreed);
          $('#form_filled').prop('checked', stay.form_filled);
          $('#notes').val(stay.notes);

          // Change modal title
          $('#addBookingModal .modal-title').text('Edit Booking');

          // Show modal
          $('#addBookingModal').modal('show');
        } else {
          alert('Error: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
      });
  }

  function deleteBooking(id) {
    if (confirm('Are you sure you want to delete this booking?')) {
      fetch(`/delete-customer/${id}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
        },
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          location.reload();
        } else {
          alert('Error: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
      });
    }
  }
</script>
{% endblock %}
