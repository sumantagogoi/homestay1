{% extends "base-homestay.html" %}

{% block title %}Documents - Homestay Management{% endblock %}
{% block page_title %}Documents{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <h3 class="card-title">All Documents</h3>
    <div class="card-tools">
      <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#uploadDocModal">
        <i class="fas fa-upload"></i> Upload Document
      </button>
    </div>
  </div>

  <div class="card-body">
    <table id="docsTable" class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>ID</th>
          <th>Document Name</th>
          <th>Type</th>
          <th>File</th>
          <th>Uploaded At</th>
          <th>Uploaded By</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for doc in documents %}
        <tr data-id="{{ doc.id }}">
          <td>{{ doc.id }}</td>
          <td>{{ doc.document_name }}</td>
          <td>
            <span class="badge badge-info">{{ doc.get_document_type_display }}</span>
          </td>
          <td>
            <a href="{{ doc.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
              <i class="fas fa-file"></i> {{ doc.filename }}
            </a>
          </td>
          <td>{{ doc.uploaded_at|date:"Y-m-d H:i" }}</td>
          <td>{{ doc.uploaded_by.username|default:"-" }}</td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="deleteDoc({{ doc.id }})">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Upload Document Modal -->
<div class="modal fade" id="uploadDocModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Upload Document</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="docForm">
          {% csrf_token %}

          <div class="form-group">
            <label for="document_name">Document Name *</label>
            <input type="text" class="form-control" id="document_name" name="document_name" required>
          </div>

          <div class="form-group">
            <label for="document_type">Document Type *</label>
            <select class="form-control" id="document_type" name="document_type" required>
              <option value="aadhaar">Aadhaar Card</option>
              <option value="passport">Passport</option>
              <option value="driving_license">Driving License</option>
              <option value="voter_id">Voter ID</option>
              <option value="other">Other ID</option>
            </select>
          </div>

          <div class="form-group">
            <label for="file">File *</label>
            <input type="file" class="form-control-file" id="file" name="file" required>
          </div>

          <div class="form-group">
            <label for="notes">Notes</label>
            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
          </div>

        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="uploadDocument()">Upload</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  $(document).ready(function() {
    // Initialize DataTable
    $('#docsTable').DataTable({
      'order': [[4, 'desc']], // Sort by uploaded date descending (newest first)
      'columnDefs': [
        { 'orderable': false, 'targets': 6 } // Disable sorting on Actions column
      ],
      'pageLength': 25,
      'language': {
        'search': 'Search documents:',
        'lengthMenu': 'Show _MENU_ documents per page',
        'info': 'Showing _START_ to _END_ of _TOTAL_ documents'
      }
    });
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + '=') {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function uploadDocument() {
    const formData = new FormData();
    const fileInput = document.getElementById('file');

    if (!fileInput.files.length) {
      alert('Please select a file');
      return;
    }

    formData.append('document_name', $('#document_name').val());
    formData.append('document_type', $('#document_type').val());
    formData.append('file', fileInput.files[0]);
    formData.append('notes', $('#notes').val());

    fetch('/bookings/documents/upload/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Document uploaded successfully!');
        location.reload();
      } else {
        alert('Error: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred');
    });
  }

  function deleteDoc(id) {
    if (confirm('Are you sure you want to delete this document?')) {
      // Delete functionality to be implemented
      alert('Delete functionality to be implemented');
    }
  }
</script>
{% endblock %}
